
<!doctype html>

<html xmlns="http://www.w3.org/1999/xhtml"  lang="en">

    <head>

        
        <meta charset="UTF-8" />

        
        <meta name="viewport" content="width=device-width, initial-scale=1"/>

                
        <title> 
               
        </title>
        
        
            <link href="https://example.com/index.xml" rel="alternate" type="application/rss+xml" title="Kiss&#39;Em!" />
        

        
        <link rel="stylesheet" href="/css/style.css"/>

        
        
            <link rel='stylesheet' href='https://example.com/css/custom.css'>
        
        
    </head>

    <body>



<section class="section">
  <div class="container">
    <nav id="nav-main" class="nav">
      <div id="nav-name" class="nav-left">
        <a id="nav-anchor" class="nav-item" href="https://example.com">
          <h1 id="nav-heading" class="title is-4">Kiss&#39;Em!</h1>
        </a>
      </div>
      <div class="nav-right">
        
        
        <nav id="nav-items" class="nav-item level is-mobile">
          <a class="level-item" aria-label="about" href='/about'
           rel='noopener'>
            <span class="icon">
              <i class>

<svg viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
    
    <circle cx="12" cy="12" r="10"></circle><line x1="12" y1="16" x2="12" y2="12"></line><line x1="12" y1="8" x2="12" y2="8"></line>
    
  </svg></i>
            </span>
          </a>
          <a class="level-item" aria-label="email" href='mailto:info@pavel-pi.de'
           target='_blank'  rel='noopener'>
            <span class="icon">
              <i class>

<svg viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
    
    <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/>
    <polyline points="22,6 12,13 2,6"/>
    
  </svg></i>
            </span>
          </a>
          <a class="level-item" aria-label="github" href='https://github.com/pavel-pi'
           target='_blank'  rel='noopener'>
            <span class="icon">
              <i class>

<svg viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
    
    <path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22"/>
    
  </svg></i>
            </span>
          </a>
          <a class="level-item" aria-label="twitter" href='https://twitter.com/@_pavel_pi_'
           target='_blank'  rel='noopener'>
            <span class="icon">
              <i class>

<svg viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
    
    <path d="M23 3a10.9 10.9 0 0 1-3.14 1.53 4.48 4.48 0 0 0-7.86 3v1A10.66 10.66 0 0 1 3 4s-4 9 5 13a11.64 11.64 0 0 1-7 2c9 5 20 0 20-11.5a4.5 4.5 0 0 0-.08-.83A7.72 7.72 0 0 0 23 3z"/>
    
  </svg></i>
            </span>
          </a>
          <a class="level-item" aria-label="rss" href='/index.xml'
           target='_blank'  rel='noopener'>
            <span class="icon">
              <i class>

<svg viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
    
    <path d="M4 11a9 9 0 0 1 9 9"></path><path d="M4 4a16 16 0 0 1 16 16"></path><circle cx="5" cy="19" r="1"></circle>
    
  </svg></i>
            </span>
          </a></nav>
        
      
      </div>
    </nav>

    <nav class="nav">
      

      
    </nav>

  </div>
</section>

<section class="section">
    
    <div class="container">
    
        
            
<div class="subtitle tags is-6 is-pulled-right">
    
</div>





<h1 class="title"></h1>

<div class="content">

    
    <h1 id="dubbo使用随机端口">dubbo使用随机端口</h1>
<h2 id="随机端口生成方式">随机端口生成方式</h2>
<p>查看源码定位到dubbo获取端口的方法在<code>doExportUrlsFor1Protocol</code></p>
<p>此方法中关于端口的代码如下：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#75715e">//从dubbo:protocol标签中读取port配置 
</span><span style="color:#75715e"></span>Integer port <span style="color:#f92672">=</span> protocolConfig<span style="color:#f92672">.</span><span style="color:#a6e22e">getPort</span><span style="color:#f92672">();</span>
<span style="color:#75715e">//如果有provider标签配置，且protocol中port配置为null 或者 0，则直接使用provider中的port端口
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span><span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">provider</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#f92672">(</span>port <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span> <span style="color:#f92672">||</span> port <span style="color:#f92672">==</span> 0<span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
            port <span style="color:#f92672">=</span> <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">provider</span><span style="color:#f92672">.</span><span style="color:#a6e22e">getPort</span><span style="color:#f92672">();</span>
        <span style="color:#f92672">}</span>
<span style="color:#75715e">//根据协议类型获取默认端口号（默认端口为20880）
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">int</span> defaultPort <span style="color:#f92672">=</span> <span style="color:#f92672">((</span>Protocol<span style="color:#f92672">)</span>ExtensionLoader<span style="color:#f92672">.</span><span style="color:#a6e22e">getExtensionLoader</span><span style="color:#f92672">(</span>Protocol<span style="color:#f92672">.</span><span style="color:#a6e22e">class</span><span style="color:#f92672">).</span><span style="color:#a6e22e">getExtension</span><span style="color:#f92672">(</span>name<span style="color:#f92672">)).</span><span style="color:#a6e22e">getDefaultPort</span><span style="color:#f92672">();</span>
<span style="color:#75715e">//如果配置port为null或者0，则会使用默认端口
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>port <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span> <span style="color:#f92672">||</span> port <span style="color:#f92672">==</span> 0<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            port <span style="color:#f92672">=</span> defaultPort<span style="color:#f92672">;</span>
        <span style="color:#f92672">}</span>
<span style="color:#75715e">//如果配置port为null或者小于0（例如-1）则使用自动端口
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>port <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span> <span style="color:#f92672">||</span> port <span style="color:#f92672">&lt;=</span> 0<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
          <span style="color:#75715e">//获取随机端口，从缓存中取
</span><span style="color:#75715e"></span>            port <span style="color:#f92672">=</span> getRandomPort<span style="color:#f92672">(</span>name<span style="color:#f92672">);</span>
          	<span style="color:#75715e">//如果获取端口为空，则以默认端口为基准，按顺序取最近一个可用的端口
</span><span style="color:#75715e"></span>            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>port <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span> <span style="color:#f92672">||</span> port <span style="color:#f92672">&lt;</span> 0<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                port <span style="color:#f92672">=</span> NetUtils<span style="color:#f92672">.</span><span style="color:#a6e22e">getAvailablePort</span><span style="color:#f92672">(</span>defaultPort<span style="color:#f92672">);</span>
              <span style="color:#75715e">//添加到随机端口的port的map
</span><span style="color:#75715e"></span>                putRandomPort<span style="color:#f92672">(</span>name<span style="color:#f92672">,</span> port<span style="color:#f92672">);</span>
            <span style="color:#f92672">}</span>

            logger<span style="color:#f92672">.</span><span style="color:#a6e22e">warn</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;Use random available port(&#34;</span> <span style="color:#f92672">+</span> port <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;) for protocol &#34;</span> <span style="color:#f92672">+</span> name<span style="color:#f92672">);</span>
        <span style="color:#f92672">}</span>
</code></pre></div><p>进一步查看NetUtils.getAvailablePort(defaultPort)方法，代码如下：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">int</span> <span style="color:#a6e22e">getAvailablePort</span><span style="color:#f92672">(</span><span style="color:#66d9ef">int</span> port<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>port <span style="color:#f92672">&lt;=</span> 0<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            <span style="color:#66d9ef">return</span> getAvailablePort<span style="color:#f92672">();</span>
        <span style="color:#f92672">}</span> <span style="color:#66d9ef">else</span> <span style="color:#f92672">{</span>
            <span style="color:#66d9ef">for</span><span style="color:#f92672">(</span><span style="color:#66d9ef">int</span> i <span style="color:#f92672">=</span> port<span style="color:#f92672">;</span> i <span style="color:#f92672">&lt;</span> 65535<span style="color:#f92672">;</span> <span style="color:#f92672">++</span>i<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                ServerSocket ss <span style="color:#f92672">=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">;</span>
								<span style="color:#75715e">//循环创建端口，假如端口被占用抛出异常并继续循环
</span><span style="color:#75715e"></span>              	<span style="color:#75715e">//当获取到可用端口后返回
</span><span style="color:#75715e"></span>                <span style="color:#66d9ef">try</span> <span style="color:#f92672">{</span>
                    ss <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> ServerSocket<span style="color:#f92672">(</span>i<span style="color:#f92672">);</span>
                    <span style="color:#66d9ef">int</span> var5 <span style="color:#f92672">=</span> i<span style="color:#f92672">;</span>
                    <span style="color:#66d9ef">return</span> var5<span style="color:#f92672">;</span>
                <span style="color:#f92672">}</span> <span style="color:#66d9ef">catch</span> <span style="color:#f92672">(</span>IOException var13<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                <span style="color:#f92672">}</span> <span style="color:#66d9ef">finally</span> <span style="color:#f92672">{</span>
                    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>ss <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                        <span style="color:#66d9ef">try</span> <span style="color:#f92672">{</span>
                            ss<span style="color:#f92672">.</span><span style="color:#a6e22e">close</span><span style="color:#f92672">();</span>
                        <span style="color:#f92672">}</span> <span style="color:#66d9ef">catch</span> <span style="color:#f92672">(</span>IOException var12<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                        <span style="color:#f92672">}</span>
                    <span style="color:#f92672">}</span>

                <span style="color:#f92672">}</span>
            <span style="color:#f92672">}</span>

            <span style="color:#66d9ef">return</span> port<span style="color:#f92672">;</span>
        <span style="color:#f92672">}</span>
    <span style="color:#f92672">}</span>

</code></pre></div><p>查看使用了哪些端口</p>
<pre><code>lsof -i|grep 5083(dubbo服务进程)|grep LISTEN 
</code></pre><h2 id="使用固定还是随机">使用固定还是随机</h2>
<p>需要注意的是，dubbo文档的推荐用法指出：</p>
<blockquote>
<p>使用固定端口暴露服务，而不要使用随机端口</p>
<p>这样在注册中心推送有延迟的情况下，消费者通过缓存列表也能调用到原地址，保证调用成功。</p>
</blockquote>
<p>我理解的场景是假如我们使用随机端口，启动了提供者，假如我们使用随机端口，随机到的端口20880,那么注册中心提供给消费者的端口为20080；当我们因为要更新提供者，并将提供者重启并使用了随机端口的方式，那么这次端口为30080，因为注册中心通知延迟，可能使用30080的提供者已经启动完毕，但是消费者没有收到通知，所以依然使用缓存的20080调用就会出错。</p>
<p>那么使用固定端口20080就不会有这个问题。</p>
<p>但是考虑实际场景和配置的复杂度，我们对接口调用的实时性应该是没有这么高的。</p>
<p>假如后期使用了容器化，每个dubbo应用作为一个容器的话，端口问题也可以得到比较好的解决。</p>


    
    
        <div class="related">

</div>
    

</div>


        

    </div>

</section>



<section class="section">
  <div class="container has-text-centered">
    <p>© <a href="https://github.com/pavel-pi">Pavel Pi</a> 2020</p>
    
      <p>Powered by <a href="https://gohugo.io/">Hugo</a> &amp; <a href="https://github.com/pavel-pi/kiss-em">Kiss'Em</a>.</p>
    
  </div>
</section>

</body>
</html>

